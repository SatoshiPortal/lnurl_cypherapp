# lnurl_cypherapp
LNURL cypherapp for cyphernode

========================

LNURL-withdraw

1. Web app calls lnurl.createLnurl

params: {

}

=========================
Web app

### createLNURL
  amount = msats
  description
  expiration = timestamp
  secretToken = k1
  webhookUrl = called back when invoice paid

returns:
  id
  LNURL string

https://service.com/api?q=3fc3645b439ce8e7f2553a69e5267081d96dcd340693afabe04be7b0ccd178df
LNURL1DP68GURN8GHJ7UM9WFMXJCM99E3K7MF0V9CXJ0M385EKVCENXC6R2C35XVUKXEFCV5MKVV34X5EKZD3EV56NYD3HXQURZEPEXEJXXEPNXSCRVWFNV9NXZCN9XQ6XYEFHVGCXXCMYXYMNSERXFQ5FNS


### deleteLNURL
  id

### getLNURL
  id

returns:
  id
  LNURL string


=========================
User/LN Wallet

### GET LNURL modalities

returns:
{
    tag: "withdrawRequest", // type of LNURL
    callback: String, // the URL which LN SERVICE would accept a withdrawal Lightning invoice as query parameter
    k1: String, // random or non-random string to identify the user's LN WALLET when using the callback URL
    defaultDescription: String, // A default withdrawal invoice description
    minWithdrawable: Integer, // Min amount (in millisatoshis) the user can withdraw from LN SERVICE, or 0
    maxWithdrawable: Integer, // Max amount (in millisatoshis) the user can withdraw from LN SERVICE, or equal to minWithdrawable if the user has no choice over the amounts
    balanceCheck: String, // Optional, an URL that can be called next time the wallet wants to perform a balance check, the call will be the same as performed in this step and the expected response is the same
}

### GET payment request

<callback>
  <?|&> // either '?' or '&' depending on whether there is a query string already in the callback
   k1=<k1> // the k1 specified in the response above
  &pr=<lightning invoice> // the payment request generated by the wallet
  &balanceNotify=<URL> // optional, see note below


=========================
=========================

DOCKER_BUILDKIT=0 docker build -t lnurl .
docker run --rm -it -v "$PWD:/lnurl" --entrypoint ash bff4412e444c
npm install

docker run --rm -it --name lnurl -v "$PWD:/lnurl" -v "$PWD/cypherapps/data:/lnurl/data" -v "$PWD/cypherapps/data/logs:/lnurl/logs" --entrypoint ash lnurl
npm run build
npm run start

--

kexkey@AlcodaZ-2 ~ % docker exec -it lnurl ash
/lnurl # apk add curl
/lnurl # curl -d '{"id":0,"method":"getConfig","params":[]}' -H "Content-Type: application/json" localhost:8000/api
{"id":0,"result":{"LOG":"DEBUG","BASE_DIR":"/lnurl","DATA_DIR":"data","DB_NAME":"lnurl.sqlite","URL_SERVER":"http://lnurl","URL_PORT":8000,"URL_CTX_WEBHOOKS":"webhooks","SESSION_TIMEOUT":600,"CN_URL":"https://gatekeeper:2009/v0","CN_API_ID":"003","CN_API_KEY":"39b83c35972aeb81a242bfe189dc0a22da5ac6cbb64072b492f2d46519a97618"}}



sqlite3 data/lnurl.sqlite -header "select * from lnurl_withdraw_request"

  amount: number;
  description?: string;
  expiration?: Date;
  secretToken: string;
  webhookUrl?: string;

curl -d '{"id":0,"method":"createLnurlWithdraw","params":{"amount":0.01,"description":"desc01","expiration":"2021-07-15 12:12","secretToken":"abc01","webhookUrl":"https://webhookUrl01"}}' -H "Content-Type: application/json" localhost:8000/api
{"id":0,"result":{"amount":0.01,"description":"desc01","expiration":"2021-07-15 12:12","secretToken":"abc01","webhookUrl":"https://webhookUrl01","lnurl":"http://.onion/lnurlWithdraw?s=abc01","withdrawnDetails":null,"withdrawnTimestamp":null,"lnurlWithdrawId":1,"createdAt":"2021-07-15 15:42:43","updatedAt":"2021-07-15 15:42:43"}}

sqlite3 data/lnurl.sqlite -header "select * from lnurl_withdraw_request"
id|amount|description|expiration|secret_token|webhook_url|lnurl|withdrawn_details|withdrawn_ts|created_ts|updated_ts
1|0.01|desc01|2021-07-15 12:12|abc01|https://webhookUrl01|http://.onion/lnurlWithdraw?s=abc01|||2021-07-15 15:42:43|2021-07-15 15:42:43

